<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CS105.L22.KHCL Final Project</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link rel="apple-touch-icon" href="images/icon.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="../files/favicon.ico" />
  </head>
  <body>
    <link rel="stylesheet" href="css/main.css" />
    <script src="js/libs/signals.min.js"></script>
    <script type="module">
      import * as THREE from "./js/three.module.js";

      import { Editor } from "./js/Editor.js";
      import { Viewport } from "./js/Viewport.js";
      import { Toolbar } from "./js/Toolbar.js";
      import { Player } from "./js/Player.js";
      import { Sidebar } from "./js/Sidebar.js";
      import { Menubar } from "./js/Menubar.js";

      window.URL = window.URL || window.webkitURL;
      window.BlobBuilder =
        window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder;

      Number.prototype.format = function () {
        return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
      };

      //

      var editor = new Editor();

      window.editor = editor; 
      window.THREE = THREE; 

      var viewport = new Viewport(editor);
      document.body.appendChild(viewport.dom);

      var toolbar = new Toolbar(editor);
      document.body.appendChild(toolbar.dom);

      var player = new Player(editor);
      document.body.appendChild(player.dom);

      var sidebar = new Sidebar(editor);
      document.body.appendChild(sidebar.dom);

      var menubar = new Menubar(editor);
      document.body.appendChild(menubar.dom);

      //

      document.addEventListener(
        "dragover",
        function (event) {
          event.preventDefault();
          event.dataTransfer.dropEffect = "copy";
        },
        false
      );

      document.addEventListener(
        "drop",
        function (event) {
          event.preventDefault();

          if (event.dataTransfer.types[0] === "text/plain") return; 
          if (event.dataTransfer.items) {
            

            editor.loader.loadItemList(event.dataTransfer.items);
          } else {
            editor.loader.loadFiles(event.dataTransfer.files);
          }
        },
        false
      );

      function onWindowResize() {
        editor.signals.windowResize.dispatch();
      }

      window.addEventListener("resize", onWindowResize, false);

      onWindowResize();

      //

      var isLoadingFromHash = false;
      var hash = window.location.hash;

      if (hash.substr(1, 5) === "file=") {
        var file = hash.substr(6);

        if (confirm("Any unsaved data will be lost. Are you sure?")) {
          var loader = new THREE.FileLoader();
          loader.crossOrigin = "";
          loader.load(file, function (text) {
            editor.clear();
            editor.fromJSON(JSON.parse(text));
          });

          isLoadingFromHash = true;
        }
      }
    </script>
  </body>
</html>
